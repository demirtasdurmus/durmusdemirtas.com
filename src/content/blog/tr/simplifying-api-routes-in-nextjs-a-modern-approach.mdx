---
title: Next.js'te API Route'larını Basitleştirme - Modern Bir Yaklaşım
description: Nexpresst kullanarak tek bir router, paylaşılan middleware, hata yönetimi ve 404 catch-all ile yapılandırılmış Next.js API'leri oluşturun.
image: /images/blog/simplifying-api-routes-in-nextjs.webp
date: '2024-09-05'
authors:
  - durmus-demirtas
---

Full-stack geliştirme dünyasında Next.js, hem client-side hem de server-side uygulamaları kolayca geliştirmek isteyen geliştiriciler için tercih edilen bir framework haline geldi. Dosya tabanlı routing yapısı ve entegre API yetenekleri onu güçlü bir seçenek kılıyor. Ancak daha karmaşık API route'larını yönetmeye geldiğinde, geliştiriciler genellikle middleware, hata yönetimi ve route organizasyonu konularında zorluklarla karşılaşıyor.

Bu yazıda, bu zorlukları basitleştiren ve Next.js'te API geliştirmeyi daha sezgisel hale getiren bir çözümü inceleyeceğiz. Global bir router kurmayı, ortak middleware'leri yönetmeyi, hata yönetimini ayarlamayı ve API route'larınızı düzenlemeyi öğreneceksiniz.

### Projeyi Oluşturma ve Bağımlılıkları Yükleme

Yeni bir Next.js projesi oluşturarak ve gerekli paketi yükleyerek başlayacağız.

Next.js projenizi oluşturun:

```bash
npx create-next-app@latest my-next-api
cd my-next-api
```

`nexpresst` paketini yükleyin:

```bash
npm install nexpresst
```

### API Router'ı Ayarlama

Ardından, tüm API route'larını yapılandırılmış ve verimli bir şekilde yönetecek bir `apiRouter` fonksiyonu oluşturacağız. Bu, API routing'inizin tutarlı ve temiz kalmasını sağlar.

```ts
// @/lib/api-router.ts

import { NextRequest } from 'next/server';
import { ApiRouter, TNextContext } from 'nexpresst';

export const apiRouter = (req: NextRequest, ctx: TNextContext) => new ApiRouter(req, ctx);
```

### Global Middleware Ekleme

Next.js varsayılan olarak request body'lerini parse etmez, bu yüzden bu sorunu çözmek için `nexpresst` paketinden `jsonParser` middleware'ini kullanacağız.

Ayrıca güvenlik amacıyla `helmet` gibi middleware'ler kullanmak yaygındır. Bunu router'ımıza entegre ederek API yanıtlarına güvenlik header'ları ekleyeceğiz. Kullanabilmek için önce `helmet` paketini yükleyin.

```ts
// @/lib/api-router.ts

import { NextRequest } from 'next/server';
import { ApiRouter, TNextContext, jsonParser, expressMiddlewareAdapter } from 'nexpresst';
import helmet from 'helmet';

export const apiRouter = (req: NextRequest, ctx: TNextContext) =>
  new ApiRouter(req, ctx).use(expressMiddlewareAdapter(helmet())).use(jsonParser);
```

### Hata Yöneticisi Kurulumu

Herhangi bir production ortamında, düzgün hata yönetimi kritik öneme sahiptir. Tüm hataları yakalayacak ve yanıtı formatlayacak bir middleware oluşturacağız.

```ts
// @/lib/middlewares/error-handler.ts

import { IMiddlewareHandler } from 'nexpresst';

type TErrorResponse = { name: string; message: string };

const errorHandler: IMiddlewareHandler<unknown, unknown, unknown, TErrorResponse> = (
  req,
  res,
  next
) => {
  return next().catch((err: unknown) => {
    if (err instanceof Error) {
      return res.statusCode(500).send({ name: err.name, message: err.message });
    }
    return res
      .statusCode(500)
      .send({ name: 'INTERNAL_SERVER_ERROR', message: 'Something went wrong' });
  });
};
```

Ardından `api-router.ts` dosyanızda:

```ts
// @/lib/api-router.ts

import { NextRequest } from 'next/server';
import { ApiRouter, TNextContext, jsonParser, expressMiddlewareAdapter } from 'nexpresst';
import helmet from 'helmet';
import { errorHandler } from '@/lib/middlewares/error-handler';

export const apiRouter = (req: NextRequest, ctx: TNextContext) =>
  new ApiRouter(req, ctx)
    .onError(errorHandler)
    .use(expressMiddlewareAdapter(helmet()))
    .use(jsonParser);
```

### 404 Route'larını Yönetme: Catch-All Kurulumu

API'nizin var olmayan route'ları düzgün bir şekilde yönetebilmesi için 404 hataları için bir catch-all handler kuruyoruz.

```ts
// @/app/api/[[...params]]/route.ts

import { apiRouter } from '@/lib/api-router';
import { exportAllHttpMethods, IRouteHandler } from 'nexpresst';

const notFoundHandler: IRouteHandler = async (req, res) => {
  return res.statusCode(404).send();
};

export const { GET, POST, PUT, DELETE, PATCH, HEAD } = exportAllHttpMethods(
  apiRouter,
  notFoundHandler
);
```

Router'a ekleyin:

```ts
// @/lib/api-router.ts
import { NextRequest } from 'next/server';
import { ApiRouter, TNextContext, jsonParser, expressMiddlewareAdapter } from 'nexpresst';
import helmet from 'helmet';
import { errorHandler } from '@/lib/middlewares/error-handler';

export const apiRouter = (req: NextRequest, ctx: TNextContext) =>
  new ApiRouter(req, ctx)
    .onError(errorHandler)
    .use(expressMiddlewareAdapter(helmet()))
    .use(jsonParser);
```

Bu, işlenmemiş tüm route'ların temiz bir 404 yanıtı döndürmesini garanti eder.

### Endpoint Oluşturma

Temel yapı hazır olduğuna göre, ilk API route'larımızı oluşturalım. Post yönetimi için basit **GET** ve **POST** endpoint'leriyle başlayacağız.

```ts
// @/app/api/posts/route.ts

import { apiRouter } from '@/lib/api-router';
import { NextRequest } from 'next/server';
import { IRouteHandler, TNextContext } from 'nexpresst';

const getPostsHandler: IRouteHandler = async (req, res) => {
  return res.statusCode(200).send({ message: 'Hello from posts' });
};

const createPostHandler: IRouteHandler = async (req, res) => {
  return res.statusCode(201).send({ message: 'Post created' });
};

export function GET(req: NextRequest, ctx: TNextContext) {
  return apiRouter(req, ctx).handle(getPostsHandler);
}

export function POST(req: NextRequest, ctx: TNextContext) {
  return apiRouter(req, ctx).handle(createPostHandler);
}
```

Route'a özel middleware'ler bile oluşturup bunları `handle` metodunu çağırmadan önce `apiRouter` instance'ınızla burada kaydedebilirsiniz.

### Sonuç

Bu sadece bir başlangıç! Bu yaklaşımı kullanarak Next.js'te API route'larının oluşturulmasını ve yönetimini basitleştirdik. Daha iyi hata yönetimi, response yönetimi, TypeScript desteği ve middleware entegrasyonu dahil olmak üzere daha birçok güçlü özellik mevcut.

Daha fazla özellik ve uygulama detayı için [Nexpresst](https://www.npmjs.com/package/nexpresst) paketine ve [örnek repository](https://github.com/demirtasdurmus/example-nextjs-api-with-nexpresst)'ye göz atın. İyi kodlamalar!
